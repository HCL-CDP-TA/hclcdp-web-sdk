"use strict";var f=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var b=Object.prototype.hasOwnProperty;var D=(i,e)=>{for(var t in e)f(i,t,{get:e[t],enumerable:!0})},E=(i,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of S(e))!b.call(i,s)&&s!==t&&f(i,s,{get:()=>e[s],enumerable:!(n=w(e,s))||n.enumerable});return i};var C=i=>E(f({},"__esModule",{value:!0}),i);var P={};D(P,{Facebook:()=>u,GoogleAnalytics:()=>y,HclCdp:()=>v});module.exports=C(P);var d=require("uuid");var l={name:"@hcl-cdp-ta/hclcdp-web-sdk",version:"0.2.0",description:"HCL CDP Web SDK",keywords:["HCLCDP"],repository:{type:"git",url:"git+https://github.com/HCL-CDP-TA/hclcdp-web-sdk.git"},license:"MIT",author:"Simon Pallister",type:"module",main:"./dist/hclcdp-web.cjs",module:"./dist/hclcdp-web.js",types:"./dist/hclcdp-web.d.ts",exports:{".":{types:"./dist/hclcdp-web.d.ts",import:"./dist/hclcdp-web.js",require:"./dist/hclcdp-web.cjs"}},scripts:{build:"tsup",dev:"tsup --watch"},dependencies:{axios:"^1.7.9","ua-parser-js":"^2.0.2",uuid:"^11.0.5"},devDependencies:{tsup:"^8.3.6",typescript:"^5.7.3",terser:"^5.39.0"}};var I=require("ua-parser-js"),g=class{profileId;deviceId;userId=null;context=null;config={writeKey:"",cdpEndpoint:"",inactivityTimeout:30,enableSessionLogging:!1};CDP_STORAGE_KEY="hclcdp_identity_data";SESSION_ID="hclcdp_session_id";constructor(){console.log("\u{1F4E6} SDK Version:",l.version);let e=this.getStoredIdentityData();e.profileId?(this.profileId=e.profileId,console.log("\u{1F504} Profile ID loaded from storage:",this.profileId)):(this.profileId=this.createProfileId(),console.log("\u2728 New Profile ID created:",this.profileId)),e.deviceId?(this.deviceId=e.deviceId,console.log("\u{1F504} Device ID loaded from storage:",this.deviceId)):(this.deviceId=this.createDeviceId(),console.log("\u2728 New Device ID created:",this.deviceId)),this.userId=e.userId||null,this.userId?console.log("\u{1F504} User ID loaded from storage:",this.userId):console.log("\u{1F464} No User ID set (anonymous user)"),this.saveIdentityData()}init=async e=>{this.config=e,console.log("CDP Initialisation initiated with config:",e);let t=(0,I.UAParser)(window.navigator.userAgent);this.context={library:{name:l.name,type:"javascript",version:l.version},userAgent:{deviceType:t.device.type||"Desktop",osType:t.os.name||"",osVersion:t.os.version||"",browser:t.browser.name||"",ua:t.ua}}};updateConfig(e){this.config={...this.config,...e}}page=async(e,t,n,s,o)=>{this.context&&s&&(this.context.utm=s);let a={type:"page",event:"page_view",name:e,id:this.profileId,deviceId:this.deviceId,userId:this.userId||"",deviceType:this.context?.userAgent.deviceType||"Unknown",originalTimestamp:Date.now(),sessionId:t,messageId:(0,d.v4)(),writeKey:this.config.writeKey||"",otherIds:{...o},context:this.context||{library:{name:"",type:""},userAgent:{deviceType:"",osType:"",osVersion:"",browser:"",ua:""}},properties:{...n}};this.sendPayload(a)};track=async(e,t,n,s)=>{this.context&&(this.context.page={path:window.location.pathname,url:window.location.href,referrer:document.referrer,title:document.title,search:document.location.search});let o={type:"track",event:e,id:this.profileId,deviceId:this.deviceId,userId:this.userId||"",deviceType:this.context?.userAgent.deviceType||"Unknown",originalTimestamp:Date.now(),sessionId:t,messageId:(0,d.v4)(),writeKey:this.config.writeKey||"",otherIds:{...s},context:this.context,properties:{...n}};console.log("Tracking event...",o),this.sendPayload(o)};identify=async(e,t,n,s)=>{this.setUserId(e);let o={type:"identify",event:"identify_event",userId:e,id:this.profileId,deviceId:this.deviceId,deviceType:this.context?.userAgent.deviceType||"Unknown",originalTimestamp:Date.now(),sessionId:t,messageId:(0,d.v4)(),writeKey:this.config.writeKey||"",otherIds:{...s},context:this.context||{library:{name:"",type:""},userAgent:{deviceType:"",osType:"",osVersion:"",browser:"",ua:""}},customerProperties:{...n}};console.log("Identify event...",o),this.sendPayload(o)};login=async(e,t,n,s,o="User_login")=>{console.log("Logging in user",this.userId),this.identify(e,t,n,s),this.config.enableUserLogoutLogging&&this.track(o,t,n,s),this.setUserId(e)};logout=async e=>{this.config.enableUserLogoutLogging&&this.track("User_logout",e),this.removeUserId()};setUserId=e=>{this.userId=e||null,this.saveIdentityData()};removeUserId=()=>{this.userId=null,localStorage.removeItem(this.SESSION_ID),this.profileId=this.createProfileId(),this.saveIdentityData()};getStoredIdentityData=()=>{let e=localStorage.getItem(this.CDP_STORAGE_KEY);if(!e)return{};try{return JSON.parse(e)}catch(t){return console.error("getStoredIdentityData - error parsing stored data:",t),{}}};saveIdentityData=()=>{let e={profileId:this.profileId,deviceId:this.deviceId,userId:this.userId||""};localStorage.setItem(this.CDP_STORAGE_KEY,JSON.stringify(e))};createProfileId=()=>(0,d.v4)();createDeviceId=()=>(0,d.v4)();getIdentityData=()=>({profileId:this.profileId,deviceId:this.deviceId,userId:this.userId||""});getProfileId=()=>this.profileId;getDeviceId=()=>this.deviceId;getUserId=()=>this.userId||"";sendPayload=async e=>{let t=new XMLHttpRequest;t.open("POST",`${this.config.cdpEndpoint.endsWith("/")?this.config.cdpEndpoint:`${this.config.cdpEndpoint}/`}analyze/analyze.php`,!0),t.withCredentials=!0,t.onload=()=>{t.status>=200&&t.status<300?console.info("Payload sent successfully:",t.responseText):console.error(`API responded with status ${t.status}:`,t.responseText)},t.onerror=n=>{console.error("Request error:",n)},t.send(JSON.stringify(e))}};var m=require("uuid"),p=class{sessionId=null;inactivityTimeout;inactivityTimer=null;SESSION_DATA="hclcdp_session";onSessionStart;onSessionEnd;constructor(e,t,n){this.inactivityTimeout=(e.inactivityTimeout||30)*60*1e3,this.onSessionStart=t||(s=>{console.log(`Default: Session started with ID: ${s}`)}),this.onSessionEnd=n||(s=>{console.log(`Default: Session ended with ID: ${s}`)}),this.initializeSession(),this.setupActivityListeners()}initializeSession(){let e=this.getSessionData();e&&this.isSessionValid(e)?(this.sessionId=e.sessionId,console.log("\u{1F504} Session ID loaded from storage:",this.sessionId),this.resetInactivityTimer()):(e&&console.log("\u23F0 Previous session expired, creating new session"),this.startNewSession())}getSessionData(){let e=sessionStorage.getItem(this.SESSION_DATA);return e?JSON.parse(e):null}saveSessionData(e){sessionStorage.setItem(this.SESSION_DATA,JSON.stringify(e))}isSessionValid(e){return Date.now()-e.lastActivityTimestamp<this.inactivityTimeout}generateSessionId(){return(0,m.v4)()}startNewSession(){this.sessionId=this.generateSessionId(),console.log("\u2728 New Session ID created:",this.sessionId);let e={sessionId:this.sessionId,lastActivityTimestamp:Date.now(),sessionStartTimestamp:Date.now()};this.saveSessionData(e),this.resetInactivityTimer(),this.onSessionStart(this.sessionId)}resetInactivityTimer(){this.inactivityTimer&&clearTimeout(this.inactivityTimer),this.inactivityTimer=setTimeout(()=>{this.endSession()},this.inactivityTimeout);let e=this.getSessionData();e&&(e.lastActivityTimestamp=Date.now(),this.saveSessionData(e))}endSession(){sessionStorage.removeItem(this.SESSION_DATA),this.sessionId&&this.onSessionEnd(this.sessionId),this.sessionId=null}setupActivityListeners(){["mousemove","keydown","scroll"].forEach(t=>{window.addEventListener(t,()=>this.resetInactivityTimer())})}getSessionId(){return this.sessionId}getFullSessionData(){return this.getSessionData()}forceNewSession(){this.sessionId&&this.endSession(),this.startNewSession()}updateTimeout(e){this.inactivityTimeout=e*60*1e3,this.resetInactivityTimer()}};var h=class i{static PAGE_QUEUE_KEY="hcl_cdp_page_queue";static TRACK_QUEUE_KEY="hcl_cdp_track_queue";static IDENTIFY_QUEUE_KEY="hcl_cdp_identify_queue";static addToQueue(e,t){let n=this.getQueue(e);n.push(t),localStorage.setItem(e,JSON.stringify(n))}static getQueue(e){let t=localStorage.getItem(e);return t?JSON.parse(t):[]}static clearQueue(e){localStorage.removeItem(e)}static flushQueue(e,t){this.getQueue(e).forEach(s=>{try{switch(e){case i.PAGE_QUEUE_KEY:t(s.pageName,s.properties,s.otherIds);break;case i.TRACK_QUEUE_KEY:t(s.eventName,s.properties,s.otherIds);break;case i.IDENTIFY_QUEUE_KEY:t(s.userId,s.properties,s.otherIds);break}}catch(o){console.error(`Error flushing ${e} event:`,o)}}),this.clearQueue(e)}},r=h;var v=class i{static instance;cdpClient=null;static deviceId=null;sessionId=null;sessionManager=null;static config={writeKey:"",cdpEndpoint:"",inactivityTimeout:30,enableSessionLogging:!1,enableUserLogoutLogging:!1};static destinations=[];constructor(){}static async init(e,t){this.destinations=e.destinations||[];for(let n of this.destinations)n.instance=new n.classRef,await n.instance.init(n.config);i.instance||(i.instance=new i),this.config={writeKey:e.writeKey,cdpEndpoint:e.cdpEndpoint,inactivityTimeout:e.inactivityTimeout||30,enableSessionLogging:e.enableSessionLogging===!0,enableUserLogoutLogging:e.enableUserLogoutLogging===!0,destinations:e.destinations||[]},i.instance.cdpClient=new g,await i.instance.cdpClient.init(e);try{r.flushQueue(r.PAGE_QUEUE_KEY,i.instance.cdpClient.page.bind(i.instance.cdpClient)),r.flushQueue(r.TRACK_QUEUE_KEY,i.instance.cdpClient.track.bind(i.instance.cdpClient)),r.flushQueue(r.IDENTIFY_QUEUE_KEY,i.instance.cdpClient.identify.bind(i.instance.cdpClient)),i.instance.sessionManager=new p(e,i.onSessionStart,i.onSessionEnd),typeof window<"u"&&(window.HclCdp?console.warn("window.HclCdp is already defined. Skipping attachment."):window.HclCdp=i);let n={};if(["_ga","_fbc","_fbp","mcmid"].forEach(o=>{let a=this.getCookie(o);a&&(n[o]=a)}),t){let o=i.getIdentityData();t(null,{deviceId:o?.deviceId||null,sessionId:i.getSessionId()||null})}}catch(n){console.log("Error initializing HCL CDP SDK:",n),t&&t(n)}}static onSessionStart=e=>{this.config?.enableSessionLogging===!0&&(i.instance?.cdpClient?i.instance.cdpClient.track("Session_Start",e):r.addToQueue(r.TRACK_QUEUE_KEY,{sessionId:e,eventName:"Session_Start",properties:{},otherIds:{}}))};static onSessionEnd=e=>{this.config?.enableSessionLogging===!0&&i.instance?.cdpClient&&i.instance.cdpClient.track("Session_End",e)};static page=async(e,t,n)=>{let s={sessionId:this.getSessionId(),pageName:e,properties:{...t,path:window.location.pathname,url:window.location.href,referrer:document.referrer,title:document.title,search:document.location.search},otherIds:n};if(this.destinations.forEach(a=>{a.instance.page({event:e,properties:s.properties})}),!i.instance||!i.instance.cdpClient){console.log("adding to queue"),r.addToQueue(r.PAGE_QUEUE_KEY,s);return}let o=this.parseUtmParameters(document.location.pathname);i.instance.cdpClient.page(e,this.getSessionId(),s.properties,o,n)};static track=async(e,t,n)=>{this.destinations.forEach(o=>{o.instance.track({event:e,properties:t})});let s={sessionId:this.getSessionId(),eventName:e,properties:t,otherIds:n};if(!i.instance||!i.instance.cdpClient){r.addToQueue(r.TRACK_QUEUE_KEY,s);return}i.instance.cdpClient.track(e,this.getSessionId(),t,n)};static identify=async(e,t,n)=>{this.destinations.forEach(o=>{o.instance.identify({properties:t})});let s={sessionId:this.getSessionId(),userId:e,properties:t,otherIds:n};if(!i.instance||!i.instance.cdpClient){r.addToQueue(r.IDENTIFY_QUEUE_KEY,s);return}i.instance.cdpClient.identify(e,this.getSessionId(),t,n)};static getIdentityData(){return i.instance?.cdpClient?i.instance.cdpClient.getIdentityData():null}static getSessionData(){return i.instance?.sessionManager?.getFullSessionData()||null}static getSessionId(){return i.instance?.sessionManager?.getSessionId()||""}static setSessionLogging(e){this.config.enableSessionLogging=e,i.instance?.cdpClient&&i.instance.cdpClient.updateConfig({enableSessionLogging:e})}static setUserLogoutLogging(e){this.config.enableUserLogoutLogging=e,i.instance?.cdpClient&&i.instance.cdpClient.updateConfig({enableUserLogoutLogging:e})}static setInactivityTimeout(e){this.config.inactivityTimeout=e,i.instance?.sessionManager&&i.instance.sessionManager.updateTimeout(e),i.instance?.cdpClient&&i.instance.cdpClient.updateConfig({inactivityTimeout:e})}static getConfig(){return{...this.config}}static logout=async()=>{i.instance?.cdpClient&&(this.config.enableUserLogoutLogging?i.instance.cdpClient.logout(this.getSessionId()):i.instance.cdpClient.logout(this.getSessionId()),i.instance.sessionManager&&i.instance.sessionManager.forceNewSession())};static parseUtmParameters=e=>{try{let t=/(?:\?|&)(utm_[^=]+)=(.*?)(?=&|$)/gi,n={},s;for(;(s=t.exec(document.URL))!==null;)n[s[1]]=s[2];return n}catch(t){return console.error("Error parsing UTM parameters:",t),{}}};static getCookie=e=>{let n=`; ${document.cookie}`.split(`; ${e}=`);return n.length===2?n.pop()?.split(";").shift()??"":""}};var u=class{facebookPixelId;async init(e){if(!e||!e.pixelId){console.error("Facebook Pixel ID is not provided.");return}this.facebookPixelId=e.pixelId;let t="facebookPixel";if(document.getElementById(t))return console.warn("Facebook Pixel script is already loaded."),Promise.resolve();{window._fbq=window._fbq||function(...o){window.fbq.callMethod?window.fbq.callMethod.apply(window.fbq,o):window.fbq.queue.push(o)},window.fbq=window.fbq||window._fbq,window.fbq.push=window.fbq,window.fbq.loaded=!0,window.fbq.disablePushState=!0,window.fbq.allowDuplicatePageViews=!0,window.fbq.version="2.0",window.fbq.queue=[],console.debug("===In Facebook init==="),window.fbq("init",this.facebookPixelId);let n=document.createElement("script");n.type="text/javascript",n.id=t,n.async=!0,n.src="https://connect.facebook.net/en_US/fbevents.js";let s=document.getElementsByTagName("script")[0];return s&&s.parentNode&&s.parentNode.insertBefore(n,s),new Promise((o,a)=>{n.onload=()=>{console.info("Facebook Pixel has been successfully initialized."),o()},n.onerror=()=>{console.error("Failed to load Facebook Pixel script."),a(new Error("Failed to load Facebook Pixel script."))}})}}track(e){console.log("===In Facebook track==="),typeof window.fbq=="function"?window.fbq("track",e.event,e.properties):console.error("Facebook Pixel is not initialized. Did you call init()?")}page(e){console.log("===In Facebook page==="),typeof window.fbq=="function"?window.fbq("track","PageView",e.properties):console.error("Facebook Pixel is not initialized. Did you call init()?")}identify(e){console.log("===In Facebook identify==="),typeof window.fbq=="function"?window.fbq("track","Identify",e.properties):console.error("Facebook Pixel is not initialized. Did you call init()?")}};var y=class{async init(e){if(!e||!e.measurementId){console.error("Google Analytics measurementId is not provided.");return}let t="google-analytics-4";if(document.getElementById(t))return console.warn("Google Analytics script is already loaded."),Promise.resolve();{let n=document.createElement("script");return n.src=`https://www.googletagmanager.com/gtag/js?id=${e.measurementId}&l=ga4DataLayer`,n.async=!0,n.type="text/javascript",n.id=t,document.getElementsByTagName("head")[0].appendChild(n),new Promise((s,o)=>{n.onload=()=>{console.debug("===GA4 script loaded==="),window.ga4DataLayer=window.ga4DataLayer||[],window.gtag=function(...a){window.ga4DataLayer.push(a)},window.gtag("js",new Date),window.gtag("config",e.measurementId),console.info("Google Analytics has been successfully initialized."),s()},n.onerror=()=>{console.error("Failed to load Google Analytics script."),o(new Error("Failed to load Google Analytics script."))}})}}track(e){console.log("===In GA4 track===",e),window.gtag("event",e.event,e.properties)}page(e){console.log("===In GA4 page===",e),window.gtag("event",e.event,e.properties)}identify(e){console.log("===In GA4 identify==="),window.gtag("set","user_properties",e.properties)}};0&&(module.exports={Facebook,GoogleAnalytics,HclCdp});
